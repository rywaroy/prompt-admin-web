import{_ as w,d as b,x as R,y as P,j as g,o as _,e as m,n as f,g as D,f as A,z as G,B as H,u as I,i as O,q as j,G as B,H as F,I as K}from"./index.54f69128.js";const S=function(c,o){if(!(this instanceof S))return new S(c,o);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=c,o=o||{},this.headers=o.headers||{},this.payload=o.payload!==void 0?o.payload:"",this.method=o.method||this.payload&&"POST"||"GET",this.withCredentials=!!o.withCredentials,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(t,e){this.listeners[t]===void 0&&(this.listeners[t]=[]),this.listeners[t].indexOf(e)===-1&&this.listeners[t].push(e)},this.removeEventListener=function(t,e){if(this.listeners[t]===void 0)return;const i=[];this.listeners[t].forEach(n=>{n!==e&&i.push(n)}),i.length===0?delete this.listeners[t]:this.listeners[t]=i},this.dispatchEvent=function(t){if(!t)return!0;t.source=this;const e=`on${t.type}`;return this.hasOwnProperty(e)&&(this[e].call(this,t),t.defaultPrevented)?!1:this.listeners[t.type]?this.listeners[t.type].every(i=>(i(t),!t.defaultPrevented)):!0},this._setReadyState=function(t){const e=new CustomEvent("readystatechange");e.readyState=t,this.readyState=t,this.dispatchEvent(e)},this._onStreamFailure=function(t){const e=new CustomEvent("error");e.data=t.currentTarget.response,this.dispatchEvent(e),this.close()},this._onStreamAbort=function(t){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(t){if(!this.xhr)return;if(this.xhr.status!==200){this._onStreamFailure(t);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));const e=this.xhr.responseText.substring(this.progress);this.progress+=e.length,e.split(/(\r\n|\r|\n){2}/g).forEach(i=>{i.trim().length===0?(this.dispatchEvent(this._parseEventChunk(this.chunk.trim())),this.chunk=""):this.chunk+=i})},this._onStreamLoaded=function(t){this._onStreamProgress(t),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(t){if(!t||t.length===0)return null;const e={id:null,retry:null,data:[],event:"message"};t.split(/\n|\r\n|\r/).forEach(n=>{n=n.trimRight();const v=n.indexOf(this.FIELD_SEPARATOR);if(v<=0)return;const l=n.substring(0,v);if(!(l in e))return;const d=n.substring(v+1).trimLeft();l==="data"?e[l].push(d):e[l]=d});const i=new CustomEvent(e.event);return i.data=e.data,i.id=e.id,i},this._checkStreamClosed=function(){if(!!this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE){try{const t=JSON.parse(this.xhr.responseText);console.log(t)}catch{this.listeners.err&&this.listeners.err.forEach(t=>t())}this._setReadyState(this.CLOSED)}},this.stream=function(){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(const t in this.headers)this.xhr.setRequestHeader(t,this.headers[t]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))}};const q=c=>(F("data-v-6c04aa0c"),c=c(),K(),c),M={class:"chat"},J={class:"out"},z={key:0,class:"avatar"},U=q(()=>f("div",{class:"chat-icon"},null,-1)),V=[U],X={key:1,class:"avatar"},Z={class:"text"},$={key:1,class:"chat-empty"},W={class:"chat-bottom"},Q={class:"chat-operation"},Y=["placeholder"],tt=b({name:"Chat"}),et=Object.assign(tt,{setup(c){const o=R(),{name:t}=P(o),e=g([]),i=g(""),n=g(!1),v=g(null);let l="";navigator.platform.indexOf("Win")!==-1?l="\u6309\u4E0BCtrl+Enter\u53D1\u9001\u6D88\u606F":navigator.platform.indexOf("Mac")!==-1&&(l="\u6309\u4E0BCommand+Enter\u53D1\u9001\u6D88\u606F");let d,r=[],u,E=!0;const x=a=>{const s=e.value[e.value.length-1];s.role==="assistant"&&(s.content+=a)},y=()=>{d&&clearInterval(d),n.value=!1,E=!0,r.length>0&&x(r.join("")),r=[],u.close()},C=a=>{const s=v.value;let h=!1;s.scrollTop+s.clientHeight+10>=s.scrollHeight&&(h=!0),B(()=>{(h||a)&&(s.scrollTop=s.scrollHeight)})},N=()=>{if(n.value)return;if(i.value)e.value.push({role:"user",content:i.value,html:i.value});else if(e.value.length===0){j.error("\u8BF7\u8F93\u5165\u5185\u5BB9");return}e.value[e.value.length-1].role!=="assistant"&&e.value.push({role:"assistant",content:"",html:""}),C(!0);const a={messages:e.value.filter(s=>s.content).map(s=>({role:s.role,content:s.content}))};i.value="",E=!1,d=setInterval(()=>{if(r.length>0){let s="";r.length>50?s=r.splice(0,25).join(""):r.length>25?s=r.splice(0,10).join(""):r.length>10?s=r.splice(0,3).join(""):s=r.shift(),x(s),C()}else E&&(n.value=!1,clearInterval(d))},60),u=new S("/api/chat",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"},payload:JSON.stringify(a),method:"POST"}),u.addEventListener("message",s=>{const h=s.data;for(let p=0;p<h.length;p++){if(h[p]==="[DONE]"){E=!0,u.close();return}const{choices:k}=JSON.parse(h[p]);k.forEach(L=>{L.delta.content&&r.push(L.delta.content)})}},!1),u.addEventListener("err",s=>{y()},!1),u.addEventListener("error",s=>{y()}),n.value=!0,u.stream()},T=a=>{a.keyCode===13&&(a.ctrlKey||a.metaKey?N():a.shiftKey)};return(a,s)=>(_(),m("div",M,[f("div",J,[f("div",{ref_key:"chatRef",ref:v,class:"chat-content"},[e.value.length>0?(_(!0),m(D,{key:0},A(e.value,(h,p)=>(_(),m("div",{key:p,class:"chat-item"},[h.role==="assistant"?(_(),m("div",z,V)):(_(),m("div",X,O(I(t)[0]),1)),f("div",Z,O(h.content),1)]))),128)):(_(),m("div",$,"ChatGPT"))],512),f("div",W,[f("div",Q,[G(f("textarea",{"onUpdate:modelValue":s[0]||(s[0]=h=>i.value=h),class:"input",type:"text",placeholder:I(l),onKeydown:T},null,40,Y),[[H,i.value]])])])])]))}});var it=w(et,[["__scopeId","data-v-6c04aa0c"]]);export{it as default};
